!function(s,e){"use strict";s.Mishy={playing:!1,paused:!1,changingCards:!1,noHelper:!1,gameMode:"",progress:0,words:"",multiplier:1,multiType:"*",time:0,timeLeft:0,romaji:!0,mainBG:[0],debug:/debug=true/.test(s.location.search),stats:{score:0,correct:0,missed:0,great:0,good:0,okay:0,wpm:0,strokes:0,time:0,hp:100,chain:0,chainMax:0},cache:{card:e.getElementById("mishy-card"),grade:e.getElementById("mishy-grade"),chain:e.getElementById("mishy-chain"),chainCount:e.getElementById("chain-count"),input:e.getElementById("game-input"),hint:e.getElementById("mishy-hint"),logo:e.getElementById("logo"),bonusArt:e.getElementById("clear-bonus-art"),main:e.getElementById("menu-main"),game:e.getElementById("game"),gameEnd:e.getElementById("game-end"),gameEndStats:e.getElementById("game-end-stats")},startGame:function(s){switch(Mishy.gameMode=s,s){case"easy":Mishy.multiplier=2,Mishy.multiType="*",Mishy.score.multi=1,Mishy.cache.hint.style.display="";break;case"normal":Mishy.multiplier=1.5,Mishy.multiType="*",Mishy.score.multi=2,Mishy.cache.hint.style.display="";break;case"hard":Mishy.multiplier=1,Mishy.multiType="*",Mishy.score.multi=3,Mishy.noHelper=!0;break;case"nightmare":Mishy.multiplier=1.5,Mishy.multiType="/",Mishy.score.multi=4,Mishy.noHelper=!0;break;case"infinity":if(Mishy.multiplier=2,Mishy.multiType="/",Mishy.score.multi=5,Mishy.noHelper=!0,!Mishy.infinityCleaned){for(var i=0,a=Mishy.mode.infinity.length;i<a;i++)Mishy.mode.infinity[i].time&&delete Mishy.mode.infinity[i].time,Mishy.mode.infinity[i].pause&&delete Mishy.mode.infinity[i].pause;Mishy.infinityCleaned=!0}}Mishy.playing=!0,e.getElementById("menu-mode").style.display="none",Mishy.cache.logo.style.display="none",Mishy.cache.bonusArt.style.display="none",Mishy.cache.game.style.display="",e.body.style.backgroundImage="",e.body.className=e.body.className.replace("main-menu","playing-game "+s+"-mode"),Mishy.nextCard(),Mishy.playTime=setInterval(function(){Mishy.paused||Mishy.stats.time++},1e3)},nextCard:function(){if(!(Mishy.stats.hp<=0)&&Mishy.playing){var s=Mishy.mode[Mishy.gameMode][Mishy.progress];if(Mishy.timer.stop(),!s)return Mishy.endGame();if(Mishy.words=s.words,Mishy.cache.card.innerHTML='<div class="mishy-card">'+(s.img||s.custom?'<div class="card-image-container"><img class="card-image" src="'+(s.custom?s.custom:getPaths()+"resources/images/game/"+(s.folder||"mishy-sticker")+"/"+s.img+".png")+'" alt="Mishy"></div>':"")+'<div class="word-zone"><div id="card-words" class="words">'+s.words+"</div>"+(s.helper&&Mishy.romaji&&!Mishy.noHelper?'<div class="helper">'+s.helper+"</div>":"")+"</div></div>",Mishy.cache.words=e.getElementById("card-words"),s.time)Mishy.time=1e3*s.time;else{switch(Mishy.time=1e3*(Mishy.mode.ja&&s.helper&&Mishy.romaji?s.helper.replace(/\s/g,""):s.words).length,Mishy.multiType){case"*":Mishy.time=Math.ceil(Mishy.time*Mishy.multiplier);break;case"/":Mishy.time=Math.ceil(Mishy.time/Mishy.multiplier)}Mishy.time<2e3&&(Mishy.time=2e3)}Mishy.timeLeft=Mishy.time,s.pause&&(Mishy.paused=!0),Mishy.timer.start(),1==Mishy.progress&&(Mishy.cache.hint.style.display="none"),Mishy.progress++,Mishy.cache.input.disabled=!1,Mishy.cache.input.focus()}},highlightText:function(s){for(var e=[],i=s.value.split(""),a=Mishy.words.split(""),t=0,h=i.length;t<h&&i[t]==a[t];t++)e.push(i[t]);e=e.join(""),new RegExp('<span class="highlighted">'+e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"</span>").test(Mishy.cache.words.innerHTML)||(Mishy.cache.words.innerHTML=Mishy.words.replace(e,'<span class="highlighted">'+e+"</span>"),e==Mishy.words&&Mishy.checkAnswer(null,!0))},WPM:{CPM:[],update:function(){Mishy.stats.strokes++,Mishy.WPM.CPM.push(Mishy.stats.time),Mishy.WPM.calculate()},calculate:function(){for(var s=0,e=Mishy.WPM.CPM.length,i=Mishy.stats.time;s<e;s++)i-Mishy.WPM.CPM[s]>60&&(Mishy.WPM.CPM.splice(s,1),s--,e=Mishy.WPM.CPM.length);Mishy.stats.wpm=Math.round(Mishy.WPM.CPM.length/5)}},checkAnswer:function(e,i){Mishy.paused&&(Mishy.paused=!1),(e&&e.value==Mishy.words&&!Mishy.changingCards||i&&!Mishy.changingCards)&&(Mishy.changingCards=!0,Mishy.stats.correct++,Mishy.timer.stop(),Mishy.showGrade(),Mishy.cache.input.blur(),Mishy.cache.input.disabled=!0,Mishy.cache.input.value="",s.setTimeout(function(){Mishy.nextCard(),Mishy.changingCards=!1},100))},showGrade:function(){var s=Mishy.timeLeft/Mishy.time*100,i=e.createElement("DIV"),a=s>75?{img:"014",txt:MishyLang.grade.great,tag:"great",pts:100,hp:5}:s<=75&&s>25?{img:"001",txt:MishyLang.grade.good,tag:"good",pts:50,hp:3}:s<=25&&s>0?{img:"007",txt:MishyLang.grade.okay,tag:"okay",pts:25,hp:1}:{img:"009",txt:MishyLang.grade.miss,tag:"miss",pts:0,hp:{easy:20,normal:30,hard:40,nightmare:50,infinity:60}[Mishy.gameMode]};Mishy.stats["miss"==a.tag?"missed":a.tag]++,Mishy.chain(s>0),"miss"!=a.tag&&Mishy.score.add(a.pts),Mishy.HP[s>0?"gain":"loss"](a.hp),i.className="mishy-grade-card grade-"+a.tag,i.innerHTML='<img class="mishy-grade-image" src="'+getPaths()+"resources/images/game/mishy-emoji/"+a.img+'.png"><div class="mishy-grade-text">'+a.txt+"</div>",storageOK&&"OFF"==localStorage["mishy-cssanime"]&&Mishy.cache.grade.firstChild&&(Mishy.cache.grade.innerHTML=""),Mishy.cache.grade.appendChild(i),setTimeout(function(){i&&i.parentNode&&Mishy.cache.grade.removeChild(i)},5e3)},HP:{life:e.getElementById("mishy-life"),inner:e.getElementById("mishy-life-inner"),bar:e.getElementById("mishy-life-bar"),face:e.getElementById("mishy-face"),gain:function(s){Mishy.stats.hp=Mishy.stats.hp+s>100?100:Mishy.stats.hp+s,Mishy.HP.life.className="hp-gain",Mishy.HP.inner.style.width=Mishy.stats.hp+"px",Mishy.HP.bar.style.width=Mishy.stats.hp+"px",Mishy.HP.changeFace()},loss:function(s){Mishy.stats.hp=Mishy.stats.hp-s<0?0:Mishy.stats.hp-s,Mishy.HP.life.className="hp-loss",Mishy.HP.inner.style.width=Mishy.stats.hp+"px",Mishy.HP.bar.style.width=Mishy.stats.hp+"px",Mishy.HP.changeFace(),Mishy.stats.hp<=0&&Mishy.endGame(!0)},changeFace:function(){var s=Mishy.stats.hp;Mishy.HP.face.src=getPaths()+"resources/images/game/mishy-emoji/"+(s>75?"001":s<=75&&s>50?"007":s<=50&&s>25?"009":s<=25&&s>0?"020":"072")+".png"}},score:{multi:1,count:e.getElementById("mishy-score"),add:function(s){Mishy.stats.score+=Math.round(s*Mishy.score.multi*Mishy.stats.chain),Mishy.score.count.innerHTML='<span data-score-anime="'+Mishy.stats.score+'">'+Mishy.stats.score+"</span>",Mishy.score.timeout&&clearTimeout(Mishy.score.timeout),Mishy.score.timeout=setTimeout(function(){Mishy.score.count.firstChild&&delete Mishy.score.count.firstChild.dataset.scoreAnime,delete Mishy.score.timeout},300)}},chain:function(s){s?(++Mishy.stats.chain>Mishy.stats.chainMax&&(Mishy.stats.chainMax=Mishy.stats.chain),Mishy.stats.chain>0&&/none/.test(Mishy.cache.chain.style.display)&&(Mishy.cache.chain.style.display=""),Mishy.cache.chainCount.innerHTML='<span data-chain-anime="'+Mishy.stats.chain+'">'+Mishy.stats.chain+"</span>",Mishy.chainTimeout&&clearTimeout(Mishy.chainTimeout),Mishy.chainTimeout=setTimeout(function(){Mishy.cache.chainCount.firstChild&&delete Mishy.cache.chainCount.firstChild.dataset.chainAnime,delete Mishy.chainTimeout},300)):(Mishy.stats.chain=0,Mishy.cache.chainCount.innerHTML=Mishy.stats.chain,Mishy.cache.chain.style.display="none")},timer:{bar:e.getElementById("mishy-time-bar"),text:e.getElementById("mishy-time"),updateTimeBar:function(){Mishy.timer.bar.style.width=Mishy.timeLeft/Mishy.time*100+"%",Mishy.timer.text.innerText=(Mishy.timeLeft/1e3).toFixed(2)},start:function(){Mishy.timer.clock&&Mishy.timer.stop(),Mishy.timer.clock=setInterval(Mishy.timer.countdown,10),Mishy.timer.updateTimeBar()},stop:function(){Mishy.timer.clock&&(clearInterval(Mishy.timer.clock),delete Mishy.timer.clock)},countdown:function(){Mishy.paused||(Mishy.timeLeft-=10,Mishy.timeLeft<=0?(Mishy.showGrade(),Mishy.cache.input.blur(),Mishy.cache.input.disabled=!0,Mishy.cache.input.value="",Mishy.timer.stop(),Mishy.timer.updateTimeBar(),Mishy.cache.input.blur(),Mishy.cache.input.disabled=!0,Mishy.changingCards=!0,setTimeout(function(){Mishy.changingCards=!1,Mishy.nextCard()},150)):Mishy.timer.updateTimeBar())}},endGame:function(s){if(Mishy.playing=!1,e.body.className=e.body.className.replace("playing-game "+Mishy.gameMode+"-mode",s?"game-over":"game-clear"),Mishy.cache.input.blur(),Mishy.cache.input.disabled=!0,Mishy.cache.input.value="",clearInterval(Mishy.playTime),Mishy.timer.stop(),GenkiModal.open({title:s?MishyLang.game_over:MishyLang.game_clear,content:'<p class="center"><span id="game-end-texts">'+MishyLang[s?"game_lose":"game_win"]+'</span><br><img src="'+getPaths()+"resources/images/game/mishy-sticker/"+(s?"031":"063")+'.png"></p>',callback:function(){Mishy.cache.game.style.display="none",Mishy.cache.gameEnd.style.display="",Mishy.cache.logo.style.display="";var e=Math.floor(Mishy.stats.time/3600),i=Math.floor(Mishy.stats.time%3600/60),a=Math.floor(Mishy.stats.time%3600%60);if(!s){for(var t=0,h=Mishy.mode[Mishy.gameMode].length,n=0;t<h;t++)Mishy.mode.ja&&Mishy.mode[Mishy.gameMode][t].helper&&Mishy.romaji?n+=Mishy.mode[Mishy.gameMode][t].helper.replace(/\s/g,"").length:n+=Mishy.mode[Mishy.gameMode][t].words.length;switch(Mishy.multiType){case"*":n*=Mishy.multiplier;break;case"/":n/=Mishy.multiplier}n=Mishy.stats.time<=Math.round(n/5)?5:Mishy.stats.time<=Math.round(n/4)?4:Mishy.stats.time<=Math.round(n/3)?3:Mishy.stats.time<=Math.round(n/2)?2:1.5}Mishy.cache.gameEndStats.innerHTML='<ul class="menu-list"><li><span class="label">'+MishyLang.stats.score+"</span>"+(s?Mishy.stats.score:Math.round(Mishy.stats.score*n))+'</span></li><li><span class="label">'+MishyLang.stats.mode+'</span><span class="game-mode mode-'+Mishy.gameMode+'">'+Mishy.gameMode.charAt(0).toUpperCase()+Mishy.gameMode.slice(1)+'</span></li><li><span class="label">'+MishyLang.stats.time+"</span>"+(e<10?"0"+e:e)+":"+(i<10?"0"+i:i)+":"+(a<10?"0"+a:a)+'</li><li><span class="label">'+MishyLang.stats.keystrokes+"</span>"+Mishy.stats.strokes+'</li><li><span class="label">'+MishyLang.stats.keyspeed+"</span>"+Mishy.stats.wpm+'<small>wpm</small></li><li><span class="label">'+MishyLang.stats.max_chain+"</span>"+Mishy.stats.chainMax+'</li><li><span class="label">'+MishyLang.stats.cards_complete+"</span>"+Mishy.stats.correct+"/"+Mishy.mode[Mishy.gameMode].length+(Mishy.stats.correct==Mishy.mode[Mishy.gameMode].length?'<span id="perfect-clear">'+MishyLang.stats.perfect+"</span>":"")+'</li><ul class="menu-list" id="grade-listing"><li><span class="label"><span class="mishy-grade-card grade-great"><img class="mishy-grade-image" src="'+getPaths()+'resources/images/game/mishy-emoji/014.png"><div class="mishy-grade-text">'+MishyLang.grade.great+"</div></span></span>"+Mishy.stats.great+'</li><li><span class="label"><span class="mishy-grade-card grade-good"><img class="mishy-grade-image" src="'+getPaths()+'resources/images/game/mishy-emoji/001.png"><div class="mishy-grade-text">'+MishyLang.grade.good+"</div></span></span>"+Mishy.stats.good+'</li><li><span class="label"><span class="mishy-grade-card grade-okay"><img class="mishy-grade-image" src="'+getPaths()+'resources/images/game/mishy-emoji/007.png"><div class="mishy-grade-text">'+MishyLang.grade.okay+"</div></span></span>"+Mishy.stats.okay+'</li><li><span class="label"><span class="mishy-grade-card grade-miss"><img class="mishy-grade-image" src="'+getPaths()+'resources/images/game/mishy-emoji/009.png"><div class="mishy-grade-text">'+MishyLang.grade.miss+"</div></span></span>"+Mishy.stats.missed+"</li></ul></ul>"},noClose:!0,buttonText:MishyLang.view_score}),storageOK&&!s)if(localStorage.mishyClear){var i=localStorage.mishyClear.split(",");i[{easy:0,normal:1,hard:2,nightmare:3,infinity:4}[Mishy.gameMode]]=1,localStorage.mishyClear=i.join(",")}else localStorage.mishyClear=("easy"==Mishy.gameMode?1:0)+","+("normal"==Mishy.gameMode?1:0)+","+("hard"==Mishy.gameMode?1:0)+","+("nightmare"==Mishy.gameMode?1:0)+","+("infinity"==Mishy.gameMode?1:0);Mishy.setClearFlags()},setClearFlags:function(){if(storageOK&&localStorage.mishyClear){for(var s=localStorage.mishyClear.split(","),i=[0],a=e.querySelectorAll(".mishy-mode-opt"),t=0,h=a.length;t<h;t++)"1"!=s[t]||/mode-clear/.test(a[t].className)||(a[t].className+=" mode-clear",Mishy.cache.bonusArt.querySelector('img[data-clear-flag="'+t+'"]').style.display="",i.push(t+1));Mishy.mainBG=i.slice()}},setMainBG:function(s){e.body.style.backgroundImage="url("+getPaths()+"resources/images/background/main/"+(s||Mishy.mainBG[Math.floor(Math.random()*Mishy.mainBG.length)])+".png)"},resetGame:function(){Mishy.setMainBG(/game-clear/.test(e.body.className)?{easy:1,normal:2,hard:3,nightmare:4,infinity:5}[Mishy.gameMode]:null),Mishy.resetGameState(),Mishy.cache.input.disabled=!1,Mishy.cache.main.style.display="",Mishy.cache.bonusArt.style.display="",Mishy.cache.gameEnd.style.display="none",e.body.className=e.body.className.replace(/game-over|game-clear/,"main-menu")},quitGame:function(){GenkiModal.open({title:"Quit Game",content:'<p class="med-text center">'+MishyLang.quit_game_prompt+"</p>",callback:function(){Mishy.cache.main.style.display="",Mishy.cache.logo.style.display="",Mishy.cache.bonusArt.style.display="",Mishy.cache.game.style.display="none",Mishy.cache.hint.style.display="none",e.body.className=e.body.className.replace("playing-game "+Mishy.gameMode+"-mode","main-menu"),clearInterval(Mishy.playTime),Mishy.timer.stop(),Mishy.resetGameState(),Mishy.setMainBG()},focus:"#genki-modal-close",buttonText:MishyLang.yes,closeButtonText:MishyLang.no})},resetGameState:function(){Mishy.playing=!1,Mishy.paused=!1,Mishy.changingCards=!1,Mishy.noHelper=!1,Mishy.gameMode="",Mishy.multiplier=1,Mishy.progress=0,Mishy.words="",Mishy.time=0,Mishy.stats={score:0,correct:0,missed:0,great:0,good:0,okay:0,wpm:0,strokes:0,time:0,hp:100,chain:0,chainMax:0},Mishy.cache.grade.innerHTML="",Mishy.WPM.CPM=[],Mishy.chain(!1),Mishy.score.add(0),Mishy.HP.gain(100)},pause:function(){Mishy.paused=!0,Mishy.cache.main.style.display="",Mishy.cache.logo.style.display="",Mishy.cache.game.style.display="none",Mishy.cache.grade.firstChild&&(Mishy.cache.grade.innerHTML="")},resume:function(){Mishy.paused=!1,Mishy.cache.main.style.display="none",Mishy.cache.logo.style.display="none",Mishy.cache.game.style.display="",Mishy.cache.input.focus()},showMenu:function(s,i){for(var a=e.getElementById("menu-"+s);!/^menu-/.test(i.id);)if("BODY"==(i=i.parentNode).tagName)return;i.style.display="none",a.style.display=""},toggle:{option:function(s,i){i=i||{};var a=storageOK&&localStorage["mishy-"+s]||(new RegExp(s+"-off").test(e.body.className)?"OFF":"ON"),t=e.getElementById("toggle-"+s);if(t){if(i.init&&"OFF"==a)a="ON";else if(i.init&&"ON"==a)return;switch(a){case"ON":e.body.className+=" "+s+"-off",t.className+=" opt-off",t.innerHTML="OFF",a="OFF",i.optionOff&&i.optionOff();break;case"OFF":e.body.className=e.body.className.replace(" "+s+"-off",""),t.className=t.className.replace(" opt-off",""),t.innerHTML="ON",a="ON",i.optionOn&&i.optionOn()}storageOK&&!i.init&&(localStorage["mishy-"+s]=a)}},furigana:function(s){this.option("furigana",{init:s})},romaji:function(s){this.option("romaji",{init:s,optionOn:function(){Mishy.romaji=!0},optionOff:function(){Mishy.romaji=!1}})},cssAnime:function(s){this.option("cssanime",{init:s})}},changeLang:function(e){var i=e.querySelector("A");i&&("file:"!=s.location.protocol||/index\.html/.test(i.href)||(i.href+="index.html"),i.click())},preload:{imgPath:getPaths()+"resources/images/",assets:function(){var s,e,i,a,t=["game/mishy-emoji/014.png","game/mishy-emoji/001.png","game/mishy-emoji/007.png","game/mishy-emoji/009.png","game/mishy-emoji/023.png","game/mishy-emoji/020.png","game/mishy-emoji/072.png","game/mishy-sticker/031.png","game/mishy-sticker/063.png","background/main/0.png","background/main/1.png","background/main/2.png","background/main/3.png","background/main/4.png","background/main/5.png","background/game/easy.png","background/game/normal.png","background/game/hard.png","background/game/nightmare.png","background/game/infinity.png","background/game/game-clear.png","background/game/game-over.png","game/mishy-emoji/078.png","game/mishy-sticker/093.png","background/extra/grass.png","game/mishy-sticker/103.png","game/mishy-sticker/011.png","game/mishy-sticker/239-clean.png","game/kiseki/tio-01.png","game/kiseki/tio-02.png","background/extra/confetti.png","game/mishy-sticker/126-clean.png","game/mishy-sticker/041-clean.png","game/mishy-emoji/039.png"];for(s in Mishy.mode)for(i in Mishy.mode[s])a="game/"+(Mishy.mode[s][i].folder?Mishy.mode[s][i].folder:"mishy-sticker")+"/"+Mishy.mode[s][i].img+".png",-1==t.indexOf(a)&&t.push(a);for(s=0,e=t.length;s<e;s++)Mishy.preload.image(t[s]);Mishy.debug&&(Mishy.preload.list=t)},image:function(s){(new Image).src=Mishy.preload.imgPath+s}},stopLoading:function(){/loading/.test(e.body.className)&&!/fade-loader-out/.test(e.body.className)&&(e.body.className+=" fade-loader-out",s.setTimeout(function(){e.body.className=e.body.className.replace(/ loading| fade-loader-out/g,"")},1e3),Mishy.loaderTimeout&&(s.clearTimeout(Mishy.loaderTimeout),delete Mishy.loaderTimeout))},init:function(){Mishy.preload.assets();for(var s in Mishy.toggle)"option"!=s&&Mishy.toggle[s](!0);Mishy.setClearFlags(),Mishy.setMainBG(),Mishy.debug&&(e.getElementById("beta-test").style.display="")}},s.onload=Mishy.stopLoading,Mishy.loaderTimeout=s.setTimeout(Mishy.stopLoading,1e4)}(window,document);