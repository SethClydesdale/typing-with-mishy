!function(e,a){"use strict";var t={playing:!1,paused:!1,changingCards:!1,noHelper:!1,gameMode:"",progress:0,words:"",multiplier:1,multiType:"*",time:0,timeLeft:0,romaji:!0,mainBG:[0],stats:{score:0,correct:0,missed:0,great:0,good:0,okay:0,wpm:0,strokes:0,time:0,hp:100,chain:0,chainMax:0},cache:{card:a.getElementById("mishy-card"),grade:a.getElementById("mishy-grade"),chain:a.getElementById("mishy-chain"),chainCount:a.getElementById("chain-count"),input:a.getElementById("game-input"),hint:a.getElementById("mishy-hint"),logo:a.getElementById("logo"),bonusArt:a.getElementById("clear-bonus-art"),main:a.getElementById("menu-main"),game:a.getElementById("game"),gameEnd:a.getElementById("game-end"),gameEndStats:a.getElementById("game-end-stats")},startGame:function(e){switch(t.gameMode=e,e){case"easy":t.multiplier=2,t.multiType="*",t.score.multi=1,t.cache.hint.style.display="";break;case"normal":t.multiplier=1,t.multiType="*",t.score.multi=2,t.cache.hint.style.display="";break;case"hard":t.multiplier=1.5,t.multiType="/",t.score.multi=3,t.noHelper=!0;break;case"nightmare":t.multiplier=2,t.multiType="/",t.score.multi=4,t.noHelper=!0;break;case"infinity":t.multiplier=2.5,t.multiType="/",t.score.multi=5,t.noHelper=!0;for(var s=[],i=0;t.mode.infinity.length;)i=Math.floor(Math.random()*t.mode.infinity.length),t.mode.infinity[i].time&&delete t.mode.infinity[i].time,t.mode.infinity[i].pause&&delete t.mode.infinity[i].pause,s.push(t.mode.infinity[i]),t.mode.infinity.splice(i,1);t.mode.infinity=s.slice()}t.playing=!0,a.getElementById("menu-mode").style.display="none",t.cache.logo.style.display="none",t.cache.bonusArt.style.display="none",t.cache.game.style.display="",a.body.style.backgroundImage="",a.body.className=a.body.className.replace("main-menu","playing-game "+e+"-mode"),t.nextCard(),t.playTime=setInterval(function(){t.paused||t.stats.time++},1e3)},nextCard:function(){if(!(t.stats.hp<=0)&&t.playing){var e=t.mode[t.gameMode][t.progress];if(t.timer.stop(),!e)return t.endGame();if(t.words=e.words,t.cache.card.innerHTML='<div class="mishy-card">'+(e.img||e.custom?'<div class="card-image"><img class="mishy" src="'+(e.custom?e.custom:getPaths()+"resources/images/game/"+(e.folder||"mishy-sticker")+"/"+e.img+".png")+'" alt="Mishy"></div>':"")+'<div class="word-zone"><div id="card-words" class="words">'+e.words+"</div>"+(e.helper&&t.romaji&&!t.noHelper?'<div class="helper">'+e.helper+"</div>":"")+"</div></div>",t.cache.words=a.getElementById("card-words"),e.time)t.time=1e3*e.time;else{switch(t.time=1e3*(t.mode.ja&&e.helper&&t.romaji?e.helper.replace(/\s/g,""):e.words).length,t.multiType){case"*":t.time=Math.ceil(t.time*t.multiplier);break;case"/":t.time=Math.ceil(t.time/t.multiplier)}t.time<2&&(t.time=2e3)}t.timeLeft=t.time,e.pause&&(t.paused=!0),t.timer.start(),1==t.progress&&(t.cache.hint.style.display="none"),t.progress++,t.cache.input.disabled=!1,t.cache.input.focus()}},highlightText:function(e){for(var a=[],s=e.value.split(""),i=t.words.split(""),n=0,c=s.length;n<c&&s[n]==i[n];n++)a.push(s[n]);a=a.join(""),new RegExp('<span class="highlighted">'+a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"</span>").test(t.cache.words.innerHTML)||(t.cache.words.innerHTML=t.words.replace(a,'<span class="highlighted">'+a+"</span>"),a==t.words&&t.checkAnswer(null,!0))},WPM:{CPM:[],update:function(){t.stats.strokes++,t.WPM.CPM.push(t.stats.time),t.WPM.calculate()},calculate:function(){for(var e=0,a=t.WPM.CPM.length,s=t.stats.time;e<a;e++)s-t.WPM.CPM[e]>60&&(t.WPM.CPM.splice(e,1),e--,a=t.WPM.CPM.length);t.stats.wpm=Math.round(t.WPM.CPM.length/5)}},checkAnswer:function(a,s){t.paused&&(t.paused=!1),(a&&a.value==t.words&&!t.changingCards||s&&!t.changingCards)&&(t.changingCards=!0,t.stats.correct++,t.timer.stop(),t.showGrade(),t.cache.input.blur(),t.cache.input.disabled=!0,t.cache.input.value="",e.setTimeout(function(){t.nextCard(),t.changingCards=!1},100))},showGrade:function(){var e=t.timeLeft/t.time*100,s=a.createElement("DIV"),i=e>75?{img:"014",txt:MishyLang.grade.great,tag:"great",pts:100,hp:5}:e<=75&&e>25?{img:"001",txt:MishyLang.grade.good,tag:"good",pts:50,hp:3}:e<=25&&e>0?{img:"007",txt:MishyLang.grade.okay,tag:"okay",pts:25,hp:1}:{img:"009",txt:MishyLang.grade.miss,tag:"miss",pts:0,hp:{easy:20,normal:30,hard:40,nightmare:50,infinity:60}[t.gameMode]};t.stats["miss"==i.tag?"missed":i.tag]++,t.chain(e>0),"miss"!=i.tag&&t.score.add(i.pts),t.HP[e>0?"gain":"loss"](i.hp),s.className="mishy-grade-card grade-"+i.tag,s.innerHTML='<img class="mishy-grade-image" src="'+getPaths()+"resources/images/game/mishy-emoji/"+i.img+'.png"><div class="mishy-grade-text">'+i.txt+"</div>",storageOK&&"OFF"==localStorage["mishy-cssanime"]&&t.cache.grade.firstChild&&(t.cache.grade.innerHTML=""),t.cache.grade.appendChild(s),setTimeout(function(){s&&s.parentNode&&t.cache.grade.removeChild(s)},5e3)},HP:{life:a.getElementById("mishy-life"),inner:a.getElementById("mishy-life-inner"),bar:a.getElementById("mishy-life-bar"),face:a.getElementById("mishy-face"),gain:function(e){t.stats.hp=t.stats.hp+e>100?100:t.stats.hp+e,t.HP.life.className="hp-gain",t.HP.inner.style.width=t.stats.hp+"px",t.HP.bar.style.width=t.stats.hp+"px",t.HP.changeFace()},loss:function(e){t.stats.hp=t.stats.hp-e<0?0:t.stats.hp-e,t.HP.life.className="hp-loss",t.HP.inner.style.width=t.stats.hp+"px",t.HP.bar.style.width=t.stats.hp+"px",t.HP.changeFace(),t.stats.hp<=0&&t.endGame(!0)},changeFace:function(){var e=t.stats.hp;t.HP.face.src=getPaths()+"resources/images/game/mishy-emoji/"+(e>75?"001":e<=75&&e>50?"007":e<=50&&e>25?"009":e<=25&&e>0?"020":"072")+".png"}},score:{multi:1,count:a.getElementById("mishy-score"),add:function(e){t.stats.score+=Math.round(e*t.score.multi*t.stats.chain),t.score.count.innerHTML='<span data-score-anime="'+t.stats.score+'">'+t.stats.score+"</span>",t.score.timeout&&clearTimeout(t.score.timeout),t.score.timeout=setTimeout(function(){t.score.count.firstChild&&delete t.score.count.firstChild.dataset.scoreAnime,delete t.score.timeout},300)}},chain:function(e){e?(++t.stats.chain>t.stats.chainMax&&(t.stats.chainMax=t.stats.chain),t.stats.chain>0&&/none/.test(t.cache.chain.style.display)&&(t.cache.chain.style.display=""),t.cache.chainCount.innerHTML='<span data-chain-anime="'+t.stats.chain+'">'+t.stats.chain+"</span>",t.chainTimeout&&clearTimeout(t.chainTimeout),t.chainTimeout=setTimeout(function(){t.cache.chainCount.firstChild&&delete t.cache.chainCount.firstChild.dataset.chainAnime,delete t.chainTimeout},300)):(t.stats.chain=0,t.cache.chainCount.innerHTML=t.stats.chain,t.cache.chain.style.display="none")},timer:{bar:a.getElementById("mishy-time-bar"),text:a.getElementById("mishy-time"),updateTimeBar:function(){t.timer.bar.style.width=t.timeLeft/t.time*100+"%",t.timer.text.innerText=(t.timeLeft/1e3).toFixed(2)},start:function(){t.timer.clock&&t.timer.stop(),t.timer.clock=setInterval(t.timer.countdown,10),t.timer.updateTimeBar()},stop:function(){t.timer.clock&&(clearInterval(t.timer.clock),delete t.timer.clock)},countdown:function(){t.paused||(t.timeLeft-=10,t.timeLeft<=0?(t.showGrade(),t.cache.input.blur(),t.cache.input.disabled=!0,t.cache.input.value="",t.timer.stop(),t.timer.updateTimeBar(),t.cache.input.blur(),t.cache.input.disabled=!0,t.changingCards=!0,setTimeout(function(){t.changingCards=!1,t.nextCard()},150)):t.timer.updateTimeBar())}},endGame:function(e){if(t.playing=!1,a.body.className=a.body.className.replace("playing-game "+t.gameMode+"-mode",e?"game-over":"game-clear"),t.cache.input.blur(),t.cache.input.disabled=!0,t.cache.input.value="",clearInterval(t.playTime),t.timer.stop(),GenkiModal.open({title:e?MishyLang.game_over:MishyLang.game_clear,content:'<p class="center"><span id="game-end-texts">'+MishyLang[e?"game_lose":"game_win"]+'</span><br><img src="'+getPaths()+"resources/images/game/mishy-sticker/"+(e?"031":"063")+'.png"></p>',callback:function(){t.cache.game.style.display="none",t.cache.gameEnd.style.display="",t.cache.logo.style.display="";var a=Math.floor(t.stats.time/3600),s=Math.floor(t.stats.time%3600/60),i=Math.floor(t.stats.time%3600%60);if(!e){for(var n=0,c=t.mode[t.gameMode].length,l=0;n<c;n++)t.mode.ja&&t.mode[t.gameMode][n].helper&&t.romaji?l+=t.mode[t.gameMode][n].helper.replace(/\s/g,"").length:l+=t.mode[t.gameMode][n].words.length;l=t.stats.time<=Math.round(l/5)?5:t.stats.time<=Math.round(l/4)?4:t.stats.time<=Math.round(l/3)?3:t.stats.time<=Math.round(l/2)?2:1.5}t.cache.gameEndStats.innerHTML='<ul class="menu-list"><li><span class="label">'+MishyLang.stats.score+"</span>"+(e?t.stats.score:Math.round(t.stats.score*l))+'</span></li><li><span class="label">'+MishyLang.stats.mode+'</span><span class="game-mode mode-'+t.gameMode+'">'+t.gameMode.charAt(0).toUpperCase()+t.gameMode.slice(1)+'</span></li><li><span class="label">'+MishyLang.stats.time+"</span>"+(a<10?"0"+a:a)+":"+(s<10?"0"+s:s)+":"+(i<10?"0"+i:i)+'</li><li><span class="label">'+MishyLang.stats.keystrokes+"</span>"+t.stats.strokes+'</li><li><span class="label">'+MishyLang.stats.keyspeed+"</span>"+t.stats.wpm+'<small>wpm</small></li><li><span class="label">'+MishyLang.stats.max_chain+"</span>"+t.stats.chainMax+'</li><li><span class="label">'+MishyLang.stats.cards_complete+"</span>"+t.stats.correct+"/"+t.mode[t.gameMode].length+(t.stats.correct==t.mode[t.gameMode].length?'<span id="perfect-clear">'+MishyLang.stats.perfect+"</span>":"")+'</li><ul class="menu-list" id="grade-listing"><li><span class="label"><span class="mishy-grade-card grade-great"><img class="mishy-grade-image" src="'+getPaths()+'resources/images/game/mishy-emoji/014.png"><div class="mishy-grade-text">'+MishyLang.grade.great+"</div></span></span>"+t.stats.great+'</li><li><span class="label"><span class="mishy-grade-card grade-good"><img class="mishy-grade-image" src="'+getPaths()+'resources/images/game/mishy-emoji/001.png"><div class="mishy-grade-text">'+MishyLang.grade.good+"</div></span></span>"+t.stats.good+'</li><li><span class="label"><span class="mishy-grade-card grade-okay"><img class="mishy-grade-image" src="'+getPaths()+'resources/images/game/mishy-emoji/007.png"><div class="mishy-grade-text">'+MishyLang.grade.okay+"</div></span></span>"+t.stats.okay+'</li><li><span class="label"><span class="mishy-grade-card grade-miss"><img class="mishy-grade-image" src="'+getPaths()+'resources/images/game/mishy-emoji/009.png"><div class="mishy-grade-text">'+MishyLang.grade.miss+"</div></span></span>"+t.stats.missed+"</li></ul></ul>"},noClose:!0,buttonText:MishyLang.view_score}),storageOK&&!e)if(localStorage.mishyClear){var s=localStorage.mishyClear.split(",");s[{easy:0,normal:1,hard:2,nightmare:3,infinity:4}[t.gameMode]]=1,localStorage.mishyClear=s.join(",")}else localStorage.mishyClear=("easy"==t.gameMode?1:0)+","+("normal"==t.gameMode?1:0)+","+("hard"==t.gameMode?1:0)+","+("nightmare"==t.gameMode?1:0)+","+("infinity"==t.gameMode?1:0);t.setClearFlags()},setClearFlags:function(){if(storageOK&&localStorage.mishyClear){for(var e=localStorage.mishyClear.split(","),s=[0],i=a.querySelectorAll(".mishy-mode-opt"),n=0,c=i.length;n<c;n++)"1"!=e[n]||/mode-clear/.test(i[n].className)||(i[n].className+=" mode-clear",t.cache.bonusArt.querySelector('img[data-clear-flag="'+n+'"]').style.display="",s.push(n+1));t.mainBG=s.slice()}},setMainBG:function(e){a.body.style.backgroundImage="url("+getPaths()+"resources/images/background/main/"+(e||t.mainBG[Math.floor(Math.random()*t.mainBG.length)])+".png)"},resetGame:function(){t.setMainBG(/game-clear/.test(a.body.className)?{easy:1,normal:2,hard:3,nightmare:4,infinity:5}[t.gameMode]:null),t.resetGameState(),t.cache.input.disabled=!1,t.cache.main.style.display="",t.cache.bonusArt.style.display="",t.cache.gameEnd.style.display="none",a.body.className=a.body.className.replace(/game-over|game-clear/,"main-menu")},quitGame:function(){GenkiModal.open({title:"Quit Game",content:'<p class="med-text center">'+MishyLang.quit_game_prompt+"</p>",callback:function(){t.cache.main.style.display="",t.cache.logo.style.display="",t.cache.bonusArt.style.display="",t.cache.game.style.display="none",t.cache.hint.style.display="none",a.body.className=a.body.className.replace("playing-game "+t.gameMode+"-mode","main-menu"),clearInterval(t.playTime),t.timer.stop(),t.resetGameState(),t.setMainBG()},focus:"#genki-modal-close",buttonText:MishyLang.yes,closeButtonText:MishyLang.no})},resetGameState:function(){t.playing=!1,t.paused=!1,t.changingCards=!1,t.noHelper=!1,t.gameMode="",t.multiplier=1,t.progress=0,t.words="",t.time=0,t.stats={score:0,correct:0,missed:0,great:0,good:0,okay:0,wpm:0,strokes:0,time:0,hp:100,chain:0,chainMax:0},t.cache.grade.innerHTML="",t.WPM.CPM=[],t.chain(!1),t.score.add(0),t.HP.gain(100)},pause:function(){t.paused=!0,t.cache.main.style.display="",t.cache.logo.style.display="",t.cache.game.style.display="none",t.cache.grade.firstChild&&(t.cache.grade.innerHTML="")},resume:function(){t.paused=!1,t.cache.main.style.display="none",t.cache.logo.style.display="none",t.cache.game.style.display="",t.cache.input.focus()},showMenu:function(e,t){for(var s=a.getElementById("menu-"+e);!/^menu-/.test(t.id);)if("BODY"==(t=t.parentNode).tagName)return;t.style.display="none",s.style.display=""},toggle:{option:function(e,t){t=t||{};var s=storageOK&&localStorage["mishy-"+e]||(new RegExp(e+"-off").test(a.body.className)?"OFF":"ON"),i=a.getElementById("toggle-"+e);if(i){if(t.init&&"OFF"==s)s="ON";else if(t.init&&"ON"==s)return;switch(s){case"ON":a.body.className+=" "+e+"-off",i.className+=" opt-off",i.innerHTML="OFF",s="OFF",t.optionOff&&t.optionOff();break;case"OFF":a.body.className=a.body.className.replace(" "+e+"-off",""),i.className=i.className.replace(" opt-off",""),i.innerHTML="ON",s="ON",t.optionOn&&t.optionOn()}storageOK&&!t.init&&(localStorage["mishy-"+e]=s)}},furigana:function(e){this.option("furigana",{init:e})},romaji:function(e){this.option("romaji",{init:e,optionOn:function(){t.romaji=!0},optionOff:function(){t.romaji=!1}})},cssAnime:function(e){this.option("cssanime",{init:e})}},changeLang:function(a){var t=a.querySelector("A");t&&("file:"!=e.location.protocol||/index\.html/.test(t.href)||(t.href+="index.html"),t.click())},init:function(){e.Mishy=this;for(var a in t.toggle)"option"!=a&&t.toggle[a](!0);t.setClearFlags(),t.setMainBG()}};t.init()}(window,document);