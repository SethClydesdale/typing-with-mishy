!function(e,s){"use strict";e.Mishy={playing:!1,paused:!1,changingCards:!1,noHelper:!1,gameMode:"",progress:0,words:"",multiplier:1,multiType:"*",time:0,timeLeft:0,romaji:!0,mainBG:[0],debug:/debug=true/.test(e.location.search),stats:{score:0,correct:0,missed:0,great:0,good:0,okay:0,wpm:0,strokes:0,time:0,hp:100,chain:0,chainMax:0},cache:{card:s.getElementById("mishy-card"),grade:s.getElementById("mishy-grade"),chain:s.getElementById("mishy-chain"),chainCount:s.getElementById("chain-count"),input:s.getElementById("game-input"),hint:s.getElementById("mishy-hint"),logo:s.getElementById("logo"),bonusArt:s.getElementById("clear-bonus-art"),main:s.getElementById("menu-main"),game:s.getElementById("game"),gameEnd:s.getElementById("game-end"),gameEndStats:s.getElementById("game-end-stats")},startGame:function(e){switch(Mishy.gameMode=e,e){case"easy":Mishy.multiplier=2,Mishy.multiType="*",Mishy.score.multi=1,Mishy.cache.hint.style.display="";break;case"normal":Mishy.multiplier=1.5,Mishy.multiType="*",Mishy.score.multi=2,Mishy.cache.hint.style.display="";break;case"hard":Mishy.multiplier=1,Mishy.multiType="*",Mishy.score.multi=3,Mishy.noHelper=!0;break;case"nightmare":Mishy.multiplier=1.5,Mishy.multiType="/",Mishy.score.multi=4,Mishy.noHelper=!0;break;case"infinity":if(Mishy.multiplier=2,Mishy.multiType="/",Mishy.score.multi=5,Mishy.noHelper=!0,!Mishy.infinityCleaned){for(var i=0,a=Mishy.mode.infinity.length;i<a;i++)Mishy.mode.infinity[i].time&&delete Mishy.mode.infinity[i].time,Mishy.mode.infinity[i].pause&&delete Mishy.mode.infinity[i].pause;Mishy.infinityCleaned=!0}}Mishy.playing=!0,s.getElementById("menu-mode").style.display="none",Mishy.cache.logo.style.display="none",Mishy.cache.bonusArt.style.display="none",Mishy.cache.game.style.display="",s.body.style.backgroundImage="",s.body.className=s.body.className.replace("main-menu","playing-game "+e+"-mode"),Mishy.nextCard(),Mishy.playTime=setInterval(function(){Mishy.paused||Mishy.stats.time++},1e3)},nextCard:function(){if(!(Mishy.stats.hp<=0)&&Mishy.playing){var e=Mishy.mode[Mishy.gameMode][Mishy.progress];if(Mishy.timer.stop(),!e)return Mishy.endGame();if(Mishy.words=e.words,Mishy.cache.card.innerHTML='<div class="mishy-card">'+(e.img||e.custom?'<div class="card-image-container"><img class="card-image" src="'+(e.custom?e.custom:getPaths()+"resources/images/game/"+(e.folder||"mishy-sticker")+"/"+e.img+".png")+'" alt="Mishy"></div>':"")+'<div class="word-zone"><div id="card-words" class="words">'+e.words+"</div>"+(e.helper&&Mishy.romaji&&!Mishy.noHelper?'<div class="helper">'+e.helper+"</div>":"")+"</div></div>",Mishy.cache.words=s.getElementById("card-words"),e.time)Mishy.time=1e3*e.time;else{switch(Mishy.time=1e3*(Mishy.mode.ja&&e.helper&&Mishy.romaji?e.helper.replace(/\s/g,""):e.words).length,Mishy.multiType){case"*":Mishy.time=Math.ceil(Mishy.time*Mishy.multiplier);break;case"/":Mishy.time=Math.ceil(Mishy.time/Mishy.multiplier)}Mishy.time<2e3&&(Mishy.time=2e3)}Mishy.timeLeft=Mishy.time,e.pause&&(Mishy.paused=!0),Mishy.timer.start(),1==Mishy.progress&&(Mishy.cache.hint.style.display="none"),Mishy.progress++,Mishy.cache.input.disabled=!1,Mishy.cache.input.focus()}},highlightText:function(e){for(var s=[],i=e.value.split(""),a=Mishy.words.split(""),t=0,n=i.length;t<n&&i[t]==a[t];t++)s.push(i[t]);s=s.join(""),new RegExp('<span class="highlighted">'+s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"</span>").test(Mishy.cache.words.innerHTML)||(Mishy.cache.words.innerHTML=Mishy.words.replace(s,'<span class="highlighted">'+s+"</span>"),s==Mishy.words&&Mishy.checkAnswer(null,!0))},WPM:{CPM:[],update:function(){Mishy.stats.strokes++,Mishy.WPM.CPM.push(Mishy.stats.time),Mishy.WPM.calculate()},calculate:function(){for(var e=0,s=Mishy.WPM.CPM.length,i=Mishy.stats.time;e<s;e++)i-Mishy.WPM.CPM[e]>60&&(Mishy.WPM.CPM.splice(e,1),e--,s=Mishy.WPM.CPM.length);Mishy.stats.wpm=Math.round(Mishy.WPM.CPM.length/5)}},checkAnswer:function(s,i){Mishy.paused&&(Mishy.paused=!1),(s&&s.value==Mishy.words&&!Mishy.changingCards||i&&!Mishy.changingCards)&&(Mishy.changingCards=!0,Mishy.stats.correct++,Mishy.timer.stop(),Mishy.showGrade(),Mishy.cache.input.blur(),Mishy.cache.input.disabled=!0,Mishy.cache.input.value="",e.setTimeout(function(){Mishy.nextCard(),Mishy.changingCards=!1},100))},showGrade:function(){var e=Mishy.timeLeft/Mishy.time*100,i=s.createElement("DIV"),a=e>75?{img:"014",txt:MishyLang.grade.great,tag:"great",pts:100,hp:5}:e<=75&&e>25?{img:"001",txt:MishyLang.grade.good,tag:"good",pts:50,hp:3}:e<=25&&e>0?{img:"007",txt:MishyLang.grade.okay,tag:"okay",pts:25,hp:1}:{img:"009",txt:MishyLang.grade.miss,tag:"miss",pts:0,hp:{easy:20,normal:30,hard:40,nightmare:50,infinity:60}[Mishy.gameMode]};Mishy.stats["miss"==a.tag?"missed":a.tag]++,Mishy.chain(e>0),"miss"!=a.tag&&Mishy.score.add(a.pts),Mishy.HP[e>0?"gain":"loss"](a.hp),i.className="mishy-grade-card grade-"+a.tag,i.innerHTML='<img class="mishy-grade-image" src="'+getPaths()+"resources/images/game/mishy-emoji/"+a.img+'.png"><div class="mishy-grade-text">'+a.txt+"</div>",storageOK&&"OFF"==localStorage["mishy-cssanime"]&&Mishy.cache.grade.firstChild&&(Mishy.cache.grade.innerHTML=""),Mishy.cache.grade.appendChild(i),setTimeout(function(){i&&i.parentNode&&Mishy.cache.grade.removeChild(i)},5e3)},HP:{life:s.getElementById("mishy-life"),inner:s.getElementById("mishy-life-inner"),bar:s.getElementById("mishy-life-bar"),face:s.getElementById("mishy-face"),gain:function(e){Mishy.stats.hp=Mishy.stats.hp+e>100?100:Mishy.stats.hp+e,Mishy.HP.life.className="hp-gain",Mishy.HP.inner.style.width=Mishy.stats.hp+"px",Mishy.HP.bar.style.width=Mishy.stats.hp+"px",Mishy.HP.changeFace()},loss:function(e){Mishy.stats.hp=Mishy.stats.hp-e<0?0:Mishy.stats.hp-e,Mishy.HP.life.className="hp-loss",Mishy.HP.inner.style.width=Mishy.stats.hp+"px",Mishy.HP.bar.style.width=Mishy.stats.hp+"px",Mishy.HP.changeFace(),Mishy.stats.hp<=0&&Mishy.endGame(!0)},changeFace:function(){var e=Mishy.stats.hp;Mishy.HP.face.src=getPaths()+"resources/images/game/mishy-emoji/"+(e>75?"001":e<=75&&e>50?"007":e<=50&&e>25?"009":e<=25&&e>0?"020":"072")+".png"}},score:{multi:1,count:s.getElementById("mishy-score"),add:function(e){Mishy.stats.score+=Math.round(e*Mishy.score.multi*Mishy.stats.chain),Mishy.score.count.innerHTML='<span data-score-anime="'+Mishy.stats.score+'">'+Mishy.stats.score+"</span>",Mishy.score.timeout&&clearTimeout(Mishy.score.timeout),Mishy.score.timeout=setTimeout(function(){Mishy.score.count.firstChild&&delete Mishy.score.count.firstChild.dataset.scoreAnime,delete Mishy.score.timeout},300)}},chain:function(e){e?(++Mishy.stats.chain>Mishy.stats.chainMax&&(Mishy.stats.chainMax=Mishy.stats.chain),Mishy.stats.chain>0&&/none/.test(Mishy.cache.chain.style.display)&&(Mishy.cache.chain.style.display=""),Mishy.cache.chainCount.innerHTML='<span data-chain-anime="'+Mishy.stats.chain+'">'+Mishy.stats.chain+"</span>",Mishy.chainTimeout&&clearTimeout(Mishy.chainTimeout),Mishy.chainTimeout=setTimeout(function(){Mishy.cache.chainCount.firstChild&&delete Mishy.cache.chainCount.firstChild.dataset.chainAnime,delete Mishy.chainTimeout},300)):(Mishy.stats.chain=0,Mishy.cache.chainCount.innerHTML=Mishy.stats.chain,Mishy.cache.chain.style.display="none")},timer:{bar:s.getElementById("mishy-time-bar"),text:s.getElementById("mishy-time"),updateTimeBar:function(){Mishy.timer.bar.style.width=Mishy.timeLeft/Mishy.time*100+"%",Mishy.timer.text.innerText=(Mishy.timeLeft/1e3).toFixed(2)},start:function(){Mishy.timer.clock&&Mishy.timer.stop(),Mishy.timer.clock=setInterval(Mishy.timer.countdown,10),Mishy.timer.updateTimeBar()},stop:function(){Mishy.timer.clock&&(clearInterval(Mishy.timer.clock),delete Mishy.timer.clock)},countdown:function(){Mishy.paused||(Mishy.timeLeft-=10,Mishy.timeLeft<=0?(Mishy.showGrade(),Mishy.cache.input.blur(),Mishy.cache.input.disabled=!0,Mishy.cache.input.value="",Mishy.timer.stop(),Mishy.timer.updateTimeBar(),Mishy.cache.input.blur(),Mishy.cache.input.disabled=!0,Mishy.changingCards=!0,setTimeout(function(){Mishy.changingCards=!1,Mishy.nextCard()},150)):Mishy.timer.updateTimeBar())}},endGame:function(e){if(Mishy.playing=!1,s.body.className=s.body.className.replace("playing-game "+Mishy.gameMode+"-mode",e?"game-over":"game-clear"),Mishy.cache.input.blur(),Mishy.cache.input.disabled=!0,Mishy.cache.input.value="",clearInterval(Mishy.playTime),Mishy.timer.stop(),GenkiModal.open({title:e?MishyLang.game_over:MishyLang.game_clear,content:'<p class="center"><span id="game-end-texts">'+MishyLang[e?"game_lose":"game_win"]+'</span><br><img src="'+getPaths()+"resources/images/game/mishy-sticker/"+(e?"031":"063")+'.png"></p>',callback:function(){Mishy.cache.game.style.display="none",Mishy.cache.gameEnd.style.display="",Mishy.cache.logo.style.display="";var s=Math.floor(Mishy.stats.time/3600),i=Math.floor(Mishy.stats.time%3600/60),a=Math.floor(Mishy.stats.time%3600%60);if(!e){for(var t=0,n=Mishy.mode[Mishy.gameMode].length,h=0;t<n;t++)Mishy.mode.ja&&Mishy.mode[Mishy.gameMode][t].helper&&Mishy.romaji?h+=Mishy.mode[Mishy.gameMode][t].helper.replace(/\s/g,"").length:h+=Mishy.mode[Mishy.gameMode][t].words.length;h*=1.5,h=Mishy.stats.time<=Math.round(h/5)?5:Mishy.stats.time<=Math.round(h/4)?4:Mishy.stats.time<=Math.round(h/3)?3:Mishy.stats.time<=Math.round(h/2)?2:1.5}Mishy.cache.gameEndStats.innerHTML='<ul class="menu-list"><li><span class="label">'+MishyLang.stats.score+"</span>"+(e?Mishy.stats.score:Math.round(Mishy.stats.score*h))+'</span></li><li><span class="label">'+MishyLang.stats.mode+'</span><span class="game-mode mode-'+Mishy.gameMode+'">'+Mishy.gameMode.charAt(0).toUpperCase()+Mishy.gameMode.slice(1)+'</span></li><li><span class="label">'+MishyLang.stats.time+"</span>"+(s<10?"0"+s:s)+":"+(i<10?"0"+i:i)+":"+(a<10?"0"+a:a)+'</li><li><span class="label">'+MishyLang.stats.keystrokes+"</span>"+Mishy.stats.strokes+'</li><li><span class="label">'+MishyLang.stats.keyspeed+"</span>"+Mishy.stats.wpm+'<small>wpm</small></li><li><span class="label">'+MishyLang.stats.max_chain+"</span>"+Mishy.stats.chainMax+'</li><li><span class="label">'+MishyLang.stats.cards_complete+"</span>"+Mishy.stats.correct+"/"+Mishy.mode[Mishy.gameMode].length+(Mishy.stats.correct==Mishy.mode[Mishy.gameMode].length?'<span id="perfect-clear">'+MishyLang.stats.perfect+"</span>":"")+'</li><ul class="menu-list" id="grade-listing"><li><span class="label"><span class="mishy-grade-card grade-great"><img class="mishy-grade-image" src="'+getPaths()+'resources/images/game/mishy-emoji/014.png"><div class="mishy-grade-text">'+MishyLang.grade.great+"</div></span></span>"+Mishy.stats.great+'</li><li><span class="label"><span class="mishy-grade-card grade-good"><img class="mishy-grade-image" src="'+getPaths()+'resources/images/game/mishy-emoji/001.png"><div class="mishy-grade-text">'+MishyLang.grade.good+"</div></span></span>"+Mishy.stats.good+'</li><li><span class="label"><span class="mishy-grade-card grade-okay"><img class="mishy-grade-image" src="'+getPaths()+'resources/images/game/mishy-emoji/007.png"><div class="mishy-grade-text">'+MishyLang.grade.okay+"</div></span></span>"+Mishy.stats.okay+'</li><li><span class="label"><span class="mishy-grade-card grade-miss"><img class="mishy-grade-image" src="'+getPaths()+'resources/images/game/mishy-emoji/009.png"><div class="mishy-grade-text">'+MishyLang.grade.miss+"</div></span></span>"+Mishy.stats.missed+"</li></ul></ul>"},noClose:!0,buttonText:MishyLang.view_score}),storageOK&&!e)if(localStorage.mishyClear){var i=localStorage.mishyClear.split(",");i[{easy:0,normal:1,hard:2,nightmare:3,infinity:4}[Mishy.gameMode]]=1,localStorage.mishyClear=i.join(",")}else localStorage.mishyClear=("easy"==Mishy.gameMode?1:0)+","+("normal"==Mishy.gameMode?1:0)+","+("hard"==Mishy.gameMode?1:0)+","+("nightmare"==Mishy.gameMode?1:0)+","+("infinity"==Mishy.gameMode?1:0);Mishy.setClearFlags()},setClearFlags:function(){if(storageOK&&localStorage.mishyClear){for(var e=localStorage.mishyClear.split(","),i=[0],a=s.querySelectorAll(".mishy-mode-opt"),t=0,n=a.length;t<n;t++)"1"!=e[t]||/mode-clear/.test(a[t].className)||(a[t].className+=" mode-clear",Mishy.cache.bonusArt.querySelector('img[data-clear-flag="'+t+'"]').style.display="",i.push(t+1));Mishy.mainBG=i.slice()}},setMainBG:function(e){s.body.style.backgroundImage="url("+getPaths()+"resources/images/background/main/"+(e||Mishy.mainBG[Math.floor(Math.random()*Mishy.mainBG.length)])+".png)"},resetGame:function(){Mishy.setMainBG(/game-clear/.test(s.body.className)?{easy:1,normal:2,hard:3,nightmare:4,infinity:5}[Mishy.gameMode]:null),Mishy.resetGameState(),Mishy.cache.input.disabled=!1,Mishy.cache.main.style.display="",Mishy.cache.bonusArt.style.display="",Mishy.cache.gameEnd.style.display="none",s.body.className=s.body.className.replace(/game-over|game-clear/,"main-menu")},quitGame:function(){GenkiModal.open({title:"Quit Game",content:'<p class="med-text center">'+MishyLang.quit_game_prompt+"</p>",callback:function(){Mishy.cache.main.style.display="",Mishy.cache.logo.style.display="",Mishy.cache.bonusArt.style.display="",Mishy.cache.game.style.display="none",Mishy.cache.hint.style.display="none",s.body.className=s.body.className.replace("playing-game "+Mishy.gameMode+"-mode","main-menu"),clearInterval(Mishy.playTime),Mishy.timer.stop(),Mishy.resetGameState(),Mishy.setMainBG()},focus:"#genki-modal-close",buttonText:MishyLang.yes,closeButtonText:MishyLang.no})},resetGameState:function(){Mishy.playing=!1,Mishy.paused=!1,Mishy.changingCards=!1,Mishy.noHelper=!1,Mishy.gameMode="",Mishy.multiplier=1,Mishy.progress=0,Mishy.words="",Mishy.time=0,Mishy.stats={score:0,correct:0,missed:0,great:0,good:0,okay:0,wpm:0,strokes:0,time:0,hp:100,chain:0,chainMax:0},Mishy.cache.grade.innerHTML="",Mishy.WPM.CPM=[],Mishy.chain(!1),Mishy.score.add(0),Mishy.HP.gain(100)},pause:function(){Mishy.paused=!0,Mishy.cache.main.style.display="",Mishy.cache.logo.style.display="",Mishy.cache.game.style.display="none",Mishy.cache.grade.firstChild&&(Mishy.cache.grade.innerHTML="")},resume:function(){Mishy.paused=!1,Mishy.cache.main.style.display="none",Mishy.cache.logo.style.display="none",Mishy.cache.game.style.display="",Mishy.cache.input.focus()},showMenu:function(e,i){for(var a=s.getElementById("menu-"+e);!/^menu-/.test(i.id);)if("BODY"==(i=i.parentNode).tagName)return;i.style.display="none",a.style.display=""},toggle:{option:function(e,i){i=i||{};var a=storageOK&&localStorage["mishy-"+e]||(new RegExp(e+"-off").test(s.body.className)?"OFF":"ON"),t=s.getElementById("toggle-"+e);if(t){if(i.init&&"OFF"==a)a="ON";else if(i.init&&"ON"==a)return;switch(a){case"ON":s.body.className+=" "+e+"-off",t.className+=" opt-off",t.innerHTML="OFF",a="OFF",i.optionOff&&i.optionOff();break;case"OFF":s.body.className=s.body.className.replace(" "+e+"-off",""),t.className=t.className.replace(" opt-off",""),t.innerHTML="ON",a="ON",i.optionOn&&i.optionOn()}storageOK&&!i.init&&(localStorage["mishy-"+e]=a)}},furigana:function(e){this.option("furigana",{init:e})},romaji:function(e){this.option("romaji",{init:e,optionOn:function(){Mishy.romaji=!0},optionOff:function(){Mishy.romaji=!1}})},cssAnime:function(e){this.option("cssanime",{init:e})}},changeLang:function(s){var i=s.querySelector("A");i&&("file:"!=e.location.protocol||/index\.html/.test(i.href)||(i.href+="index.html"),i.click())},preload:{imgPath:getPaths()+"resources/images/",assets:function(){var e,s,i,a,t=["game/mishy-emoji/014.png","game/mishy-emoji/001.png","game/mishy-emoji/007.png","game/mishy-emoji/009.png","game/mishy-emoji/023.png","game/mishy-emoji/020.png","game/mishy-emoji/072.png","game/mishy-sticker/031.png","game/mishy-sticker/063.png","background/main/0.png","background/main/1.png","background/main/2.png","background/main/3.png","background/main/4.png","background/main/5.png","background/game/easy.png","background/game/normal.png","background/game/hard.png","background/game/nightmare.png","background/game/infinity.png","background/game/game-clear.png","background/game/game-over.png","game/mishy-emoji/078.png","game/mishy-sticker/093.png","background/extra/grass.png","game/mishy-sticker/103.png","game/mishy-sticker/011.png","game/mishy-sticker/239-clean.png","game/kiseki/tio-01.png","game/kiseki/tio-02.png","background/extra/confetti.png","game/mishy-sticker/126-clean.png","game/mishy-sticker/041-clean.png","game/mishy-sticker/004.png","game/kiseki/tio-06.png","background/extra/clouds.png","game/kiseki/lloyd-elie.png","game/kiseki/randy-kea.png","game/kiseki/mishy-tio.png","game/mishy-emoji/039.png"];for(e in Mishy.mode)for(i in Mishy.mode[e])Mishy.mode[e][i].img&&(a="game/"+(Mishy.mode[e][i].folder?Mishy.mode[e][i].folder:"mishy-sticker")+"/"+Mishy.mode[e][i].img+".png",-1==t.indexOf(a)&&t.push(a));for(e=0,s=t.length;e<s;e++)Mishy.preload.image(t[e]);Mishy.debug&&(Mishy.preload.list=t)},image:function(e){(new Image).src=Mishy.preload.imgPath+e}},stopLoading:function(){/loading/.test(s.body.className)&&!/fade-loader-out/.test(s.body.className)&&(s.body.className+=" fade-loader-out",e.setTimeout(function(){s.body.className=s.body.className.replace(/ loading| fade-loader-out/g,"")},1e3),Mishy.loaderTimeout&&(e.clearTimeout(Mishy.loaderTimeout),delete Mishy.loaderTimeout))},init:function(){Mishy.preload.assets();for(var e in Mishy.toggle)"option"!=e&&Mishy.toggle[e](!0);if(Mishy.setClearFlags(),Mishy.setMainBG(),Mishy.debug){var i=s.getElementById("beta-test");i&&(i.style.display=""),Mishy.debugTools={prev:function(){Mishy.progress=Mishy.progress-2<=-1?0:Mishy.progress-2,Mishy.nextCard(),Mishy.cache.debugCardIndex.value=Mishy.progress,Mishy.cache.debugCardIndex.max=Mishy.mode[Mishy.gameMode].length,Mishy.paused=!0},next:function(){Mishy.nextCard(),Mishy.cache.debugCardIndex.value=Mishy.progress,Mishy.cache.debugCardIndex.max=Mishy.mode[Mishy.gameMode].length,Mishy.paused=!0}};var a=s.createElement("DIV");a.id="mishy-debugger",a.innerHTML='<button class="button" onmousedown="Mishy.debugTools.prev(); window.CardChange = setInterval(Mishy.debugTools.prev, 200);" onmouseup="window.CardChange && clearInterval(CardChange);" onmouseout="window.CardChange && clearInterval(CardChange);">Prev</button><input id="debug-card-index" type="number" onchange="Mishy.progress = this.value; this.max = Mishy.mode[Mishy.gameMode].length;" min="0" value="1"><button class="button" onmousedown="Mishy.debugTools.next(); window.CardChange = setInterval(Mishy.debugTools.next, 200);" onmouseup="window.CardChange && clearInterval(CardChange);" onmouseout="window.CardChange && clearInterval(CardChange);">Next</button>',s.getElementById("input-zone").insertBefore(a,s.getElementById("mishy-hint")),Mishy.cache.debugCardIndex=s.getElementById("debug-card-index")}}},e.onload=Mishy.stopLoading,Mishy.loaderTimeout=e.setTimeout(Mishy.stopLoading,1e4)}(window,document);