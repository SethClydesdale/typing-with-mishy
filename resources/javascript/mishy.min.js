!function(e,a){"use strict";var s={playing:!1,paused:!1,changingCards:!1,noHelper:!1,gameMode:"",progress:0,words:"",multiplier:1,multiType:"*",time:0,timeLeft:0,romaji:!0,mainBG:[0],stats:{score:0,correct:0,missed:0,great:0,good:0,okay:0,wpm:0,strokes:0,time:0,hp:100,chain:0,chainMax:0},cache:{card:a.getElementById("mishy-card"),grade:a.getElementById("mishy-grade"),chain:a.getElementById("mishy-chain"),chainCount:a.getElementById("chain-count"),input:a.getElementById("game-input"),hint:a.getElementById("mishy-hint"),logo:a.getElementById("logo"),bonusArt:a.getElementById("clear-bonus-art"),main:a.getElementById("menu-main"),game:a.getElementById("game"),gameEnd:a.getElementById("game-end"),gameEndStats:a.getElementById("game-end-stats")},startGame:function(e){switch(s.gameMode=e,e){case"easy":s.multiplier=2,s.multiType="*",s.score.multi=1,s.cache.hint.style.display="";break;case"normal":s.multiplier=1,s.multiType="*",s.score.multi=2,s.cache.hint.style.display="";break;case"hard":s.multiplier=1.5,s.multiType="/",s.score.multi=3,s.noHelper=!0;break;case"nightmare":s.multiplier=2,s.multiType="/",s.score.multi=4,s.noHelper=!0;break;case"infinity":s.multiplier=2.5,s.multiType="/",s.score.multi=5,s.noHelper=!0;for(var t=[],i=0;s.mode.infinity.length;)i=Math.floor(Math.random()*s.mode.infinity.length),s.mode.infinity[i].time&&delete s.mode.infinity[i].time,s.mode.infinity[i].pause&&delete s.mode.infinity[i].pause,t.push(s.mode.infinity[i]),s.mode.infinity.splice(i,1);s.mode.infinity=t.slice()}s.playing=!0,a.getElementById("menu-mode").style.display="none",s.cache.logo.style.display="none",s.cache.bonusArt.style.display="none",s.cache.game.style.display="",a.body.style.backgroundImage="",a.body.className=a.body.className.replace("main-menu","playing-game "+e+"-mode"),s.nextCard(),s.playTime=setInterval(function(){s.paused||s.stats.time++},1e3)},nextCard:function(){if(!(s.stats.hp<=0)&&s.playing){var e=s.mode[s.gameMode][s.progress];if(s.timer.stop(),!e)return s.endGame();if(s.words=e.words,s.cache.card.innerHTML='<div class="mishy-card">'+(e.img||e.custom?'<div class="card-image"><img class="mishy" src="'+(e.custom?e.custom:getPaths()+"resources/images/game/"+(e.folder||"mishy-sticker")+"/"+e.img+".png")+'" alt="Mishy"></div>':"")+'<div class="word-zone"><div id="card-words" class="words">'+e.words+"</div>"+(e.helper&&s.romaji&&!s.noHelper?'<div class="helper">'+e.helper+"</div>":"")+"</div></div>",s.cache.words=a.getElementById("card-words"),e.time)s.time=1e3*e.time;else{switch(s.time=1e3*(s.mode.ja&&e.helper&&s.romaji?e.helper.replace(/\s/g,""):e.words).length,s.multiType){case"*":s.time=Math.ceil(s.time*s.multiplier);break;case"/":s.time=Math.ceil(s.time/s.multiplier)}s.time<2&&(s.time=2e3)}s.timeLeft=s.time,e.pause&&(s.paused=!0),s.timer.start(),1==s.progress&&(s.cache.hint.style.display="none"),s.progress++,s.cache.input.disabled=!1,s.cache.input.focus()}},highlightText:function(e){for(var a=[],t=e.value.split(""),i=s.words.split(""),n=0,c=t.length;n<c&&t[n]==i[n];n++)a.push(t[n]);a=a.join(""),new RegExp('<span class="highlighted">'+a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"</span>").test(s.cache.words.innerHTML)||(s.cache.words.innerHTML=s.words.replace(a,'<span class="highlighted">'+a+"</span>"),a==s.words&&s.checkAnswer(null,!0))},WPM:{CPM:[],update:function(){s.stats.strokes++,s.WPM.CPM.push(s.stats.time),s.WPM.calculate()},calculate:function(){for(var e=0,a=s.WPM.CPM.length,t=s.stats.time;e<a;e++)t-s.WPM.CPM[e]>60&&(s.WPM.CPM.splice(e,1),e--,a=s.WPM.CPM.length);s.stats.wpm=Math.round(s.WPM.CPM.length/5)}},checkAnswer:function(a,t){s.paused&&(s.paused=!1),(a&&a.value==s.words&&!s.changingCards||t&&!s.changingCards)&&(s.changingCards=!0,s.stats.correct++,s.timer.stop(),s.showGrade(),s.cache.input.blur(),s.cache.input.disabled=!0,s.cache.input.value="",e.setTimeout(function(){s.nextCard(),s.changingCards=!1},100))},showGrade:function(){var e=s.timeLeft/s.time*100,t=a.createElement("DIV"),i=e>75?{img:"014",txt:MishyLang.grade.great,tag:"great",pts:100,hp:5}:e<=75&&e>25?{img:"001",txt:MishyLang.grade.good,tag:"good",pts:50,hp:3}:e<=25&&e>0?{img:"007",txt:MishyLang.grade.okay,tag:"okay",pts:25,hp:1}:{img:"009",txt:MishyLang.grade.miss,tag:"miss",pts:0,hp:{easy:20,normal:30,hard:40,nightmare:50,infinity:60}[s.gameMode]};s.stats["miss"==i.tag?"missed":i.tag]++,s.chain(e>0),"miss"!=i.tag&&s.score.add(i.pts),s.HP[e>0?"gain":"loss"](i.hp),t.className="mishy-grade-card grade-"+i.tag,t.innerHTML='<img class="mishy-grade-image" src="'+getPaths()+"resources/images/game/mishy-emoji/"+i.img+'.png"><div class="mishy-grade-text">'+i.txt+"</div>",storageOK&&"OFF"==localStorage["mishy-cssanime"]&&s.cache.grade.firstChild&&(s.cache.grade.innerHTML=""),s.cache.grade.appendChild(t),setTimeout(function(){t&&t.parentNode&&s.cache.grade.removeChild(t)},5e3)},HP:{life:a.getElementById("mishy-life"),inner:a.getElementById("mishy-life-inner"),bar:a.getElementById("mishy-life-bar"),face:a.getElementById("mishy-face"),gain:function(e){s.stats.hp=s.stats.hp+e>100?100:s.stats.hp+e,s.HP.life.className="hp-gain",s.HP.inner.style.width=s.stats.hp+"px",s.HP.bar.style.width=s.stats.hp+"px",s.HP.changeFace()},loss:function(e){s.stats.hp=s.stats.hp-e<0?0:s.stats.hp-e,s.HP.life.className="hp-loss",s.HP.inner.style.width=s.stats.hp+"px",s.HP.bar.style.width=s.stats.hp+"px",s.HP.changeFace(),s.stats.hp<=0&&s.endGame(!0)},changeFace:function(){var e=s.stats.hp;s.HP.face.src=getPaths()+"resources/images/game/mishy-emoji/"+(e>75?"001":e<=75&&e>50?"007":e<=50&&e>25?"009":e<=25&&e>0?"020":"072")+".png"}},score:{multi:1,count:a.getElementById("mishy-score"),add:function(e){s.stats.score+=Math.round(e*s.score.multi*s.stats.chain),s.score.count.innerHTML='<span data-score-anime="'+s.stats.score+'">'+s.stats.score+"</span>",s.score.timeout&&clearTimeout(s.score.timeout),s.score.timeout=setTimeout(function(){s.score.count.firstChild&&delete s.score.count.firstChild.dataset.scoreAnime,delete s.score.timeout},300)}},chain:function(e){e?(++s.stats.chain>s.stats.chainMax&&(s.stats.chainMax=s.stats.chain),s.stats.chain>0&&/none/.test(s.cache.chain.style.display)&&(s.cache.chain.style.display=""),s.cache.chainCount.innerHTML='<span data-chain-anime="'+s.stats.chain+'">'+s.stats.chain+"</span>",s.chainTimeout&&clearTimeout(s.chainTimeout),s.chainTimeout=setTimeout(function(){s.cache.chainCount.firstChild&&delete s.cache.chainCount.firstChild.dataset.chainAnime,delete s.chainTimeout},300)):(s.stats.chain=0,s.cache.chainCount.innerHTML=s.stats.chain,s.cache.chain.style.display="none")},timer:{bar:a.getElementById("mishy-time-bar"),text:a.getElementById("mishy-time"),updateTimeBar:function(){s.timer.bar.style.width=s.timeLeft/s.time*100+"%",s.timer.text.innerText=(s.timeLeft/1e3).toFixed(2)},start:function(){s.timer.clock&&s.timer.stop(),s.timer.clock=setInterval(s.timer.countdown,10),s.timer.updateTimeBar()},stop:function(){s.timer.clock&&(clearInterval(s.timer.clock),delete s.timer.clock)},countdown:function(){s.paused||(s.timeLeft-=10,s.timeLeft<=0?(s.showGrade(),s.cache.input.blur(),s.cache.input.disabled=!0,s.cache.input.value="",s.timer.stop(),s.timer.updateTimeBar(),s.cache.input.blur(),s.cache.input.disabled=!0,s.changingCards=!0,setTimeout(function(){s.changingCards=!1,s.nextCard()},150)):s.timer.updateTimeBar())}},endGame:function(e){if(s.playing=!1,a.body.className=a.body.className.replace("playing-game "+s.gameMode+"-mode",e?"game-over":"game-clear"),s.cache.input.blur(),s.cache.input.disabled=!0,s.cache.input.value="",clearInterval(s.playTime),s.timer.stop(),GenkiModal.open({title:e?MishyLang.game_over:MishyLang.game_clear,content:'<p class="center"><span id="game-end-texts">'+MishyLang[e?"game_lose":"game_win"]+'</span><br><img src="'+getPaths()+"resources/images/game/mishy-sticker/"+(e?"031":"063")+'.png"></p>',callback:function(){s.cache.game.style.display="none",s.cache.gameEnd.style.display="",s.cache.logo.style.display="";var a=Math.floor(s.stats.time/3600),t=Math.floor(s.stats.time%3600/60),i=Math.floor(s.stats.time%3600%60);if(!e){for(var n=0,c=s.mode[s.gameMode].length,m=0;n<c;n++)s.mode.ja&&s.mode[s.gameMode][n].helper&&s.romaji?m+=s.mode[s.gameMode][n].helper.replace(/\s/g,"").length:m+=s.mode[s.gameMode][n].words.length;m=s.stats.time<=Math.round(m/5)?5:s.stats.time<=Math.round(m/4)?4:s.stats.time<=Math.round(m/3)?3:s.stats.time<=Math.round(m/2)?2:1.5}s.cache.gameEndStats.innerHTML='<ul class="menu-list"><li><span class="label">'+MishyLang.stats.score+"</span>"+(e?s.stats.score:Math.round(s.stats.score*m))+'</span></li><li><span class="label">'+MishyLang.stats.mode+'</span><span class="game-mode mode-'+s.gameMode+'">'+s.gameMode.charAt(0).toUpperCase()+s.gameMode.slice(1)+'</span></li><li><span class="label">'+MishyLang.stats.time+"</span>"+(a<10?"0"+a:a)+":"+(t<10?"0"+t:t)+":"+(i<10?"0"+i:i)+'</li><li><span class="label">'+MishyLang.stats.keystrokes+"</span>"+s.stats.strokes+'</li><li><span class="label">'+MishyLang.stats.keyspeed+"</span>"+s.stats.wpm+'<small>wpm</small></li><li><span class="label">'+MishyLang.stats.max_chain+"</span>"+s.stats.chainMax+'</li><li><span class="label">'+MishyLang.stats.cards_complete+"</span>"+s.stats.correct+"/"+s.mode[s.gameMode].length+(s.stats.correct==s.mode[s.gameMode].length?'<span id="perfect-clear">'+MishyLang.stats.perfect+"</span>":"")+'</li><ul class="menu-list" id="grade-listing"><li><span class="label"><span class="mishy-grade-card grade-great"><img class="mishy-grade-image" src="'+getPaths()+'resources/images/game/mishy-emoji/014.png"><div class="mishy-grade-text">'+MishyLang.grade.great+"</div></span></span>"+s.stats.great+'</li><li><span class="label"><span class="mishy-grade-card grade-good"><img class="mishy-grade-image" src="'+getPaths()+'resources/images/game/mishy-emoji/001.png"><div class="mishy-grade-text">'+MishyLang.grade.good+"</div></span></span>"+s.stats.good+'</li><li><span class="label"><span class="mishy-grade-card grade-okay"><img class="mishy-grade-image" src="'+getPaths()+'resources/images/game/mishy-emoji/007.png"><div class="mishy-grade-text">'+MishyLang.grade.okay+"</div></span></span>"+s.stats.okay+'</li><li><span class="label"><span class="mishy-grade-card grade-miss"><img class="mishy-grade-image" src="'+getPaths()+'resources/images/game/mishy-emoji/009.png"><div class="mishy-grade-text">'+MishyLang.grade.miss+"</div></span></span>"+s.stats.missed+"</li></ul></ul>"},noClose:!0,buttonText:MishyLang.view_score}),storageOK&&!e)if(localStorage.mishyClear){var t=localStorage.mishyClear.split(",");t[{easy:0,normal:1,hard:2,nightmare:3,infinity:4}[s.gameMode]]=1,localStorage.mishyClear=t.join(",")}else localStorage.mishyClear=("easy"==s.gameMode?1:0)+","+("normal"==s.gameMode?1:0)+","+("hard"==s.gameMode?1:0)+","+("nightmare"==s.gameMode?1:0)+","+("infinity"==s.gameMode?1:0);s.setClearFlags()},setClearFlags:function(){if(storageOK&&localStorage.mishyClear){for(var e=localStorage.mishyClear.split(","),t=[0],i=a.querySelectorAll(".mishy-mode-opt"),n=0,c=i.length;n<c;n++)"1"!=e[n]||/mode-clear/.test(i[n].className)||(i[n].className+=" mode-clear",s.cache.bonusArt.querySelector('img[data-clear-flag="'+n+'"]').style.display="",t.push(n+1));s.mainBG=t.slice()}},setMainBG:function(e){a.body.style.backgroundImage="url("+getPaths()+"resources/images/background/main/"+(e||s.mainBG[Math.floor(Math.random()*s.mainBG.length)])+".png)"},resetGame:function(){s.setMainBG(/game-clear/.test(a.body.className)?{easy:1,normal:2,hard:3,nightmare:4,infinity:5}[s.gameMode]:null),s.resetGameState(),s.cache.input.disabled=!1,s.cache.main.style.display="",s.cache.bonusArt.style.display="",s.cache.gameEnd.style.display="none",a.body.className=a.body.className.replace(/game-over|game-clear/,"main-menu")},quitGame:function(){GenkiModal.open({title:"Quit Game",content:'<p class="med-text center">'+MishyLang.quit_game_prompt+"</p>",callback:function(){s.cache.main.style.display="",s.cache.logo.style.display="",s.cache.bonusArt.style.display="",s.cache.game.style.display="none",s.cache.hint.style.display="none",a.body.className=a.body.className.replace("playing-game "+s.gameMode+"-mode","main-menu"),clearInterval(s.playTime),s.timer.stop(),s.resetGameState(),s.setMainBG()},focus:"#genki-modal-close",buttonText:MishyLang.yes,closeButtonText:MishyLang.no})},resetGameState:function(){s.playing=!1,s.paused=!1,s.changingCards=!1,s.noHelper=!1,s.gameMode="",s.multiplier=1,s.progress=0,s.words="",s.time=0,s.stats={score:0,correct:0,missed:0,great:0,good:0,okay:0,wpm:0,strokes:0,time:0,hp:100,chain:0,chainMax:0},s.cache.grade.innerHTML="",s.WPM.CPM=[],s.chain(!1),s.score.add(0),s.HP.gain(100)},pause:function(){s.paused=!0,s.cache.main.style.display="",s.cache.logo.style.display="",s.cache.game.style.display="none",s.cache.grade.firstChild&&(s.cache.grade.innerHTML="")},resume:function(){s.paused=!1,s.cache.main.style.display="none",s.cache.logo.style.display="none",s.cache.game.style.display="",s.cache.input.focus()},showMenu:function(e,s){for(var t=a.getElementById("menu-"+e);!/^menu-/.test(s.id);)if("BODY"==(s=s.parentNode).tagName)return;s.style.display="none",t.style.display=""},toggle:{option:function(e,s){s=s||{};var t=storageOK&&localStorage["mishy-"+e]||(new RegExp(e+"-off").test(a.body.className)?"OFF":"ON"),i=a.getElementById("toggle-"+e);if(i){if(s.init&&"OFF"==t)t="ON";else if(s.init&&"ON"==t)return;switch(t){case"ON":a.body.className+=" "+e+"-off",i.className+=" opt-off",i.innerHTML="OFF",t="OFF",s.optionOff&&s.optionOff();break;case"OFF":a.body.className=a.body.className.replace(" "+e+"-off",""),i.className=i.className.replace(" opt-off",""),i.innerHTML="ON",t="ON",s.optionOn&&s.optionOn()}storageOK&&!s.init&&(localStorage["mishy-"+e]=t)}},furigana:function(e){this.option("furigana",{init:e})},romaji:function(e){this.option("romaji",{init:e,optionOn:function(){s.romaji=!0},optionOff:function(){s.romaji=!1}})},cssAnime:function(e){this.option("cssanime",{init:e})}},changeLang:function(a){var s=a.querySelector("A");s&&("file:"!=e.location.protocol||/index\.html/.test(s.href)||(s.href+="index.html"),s.click())},preload:{imgPath:getPaths()+"resources/images/",assets:function(){var e,a,t,i,n=["game/mishy-emoji/014.png","game/mishy-emoji/001.png","game/mishy-emoji/007.png","game/mishy-emoji/009.png","game/mishy-emoji/023.png","game/mishy-emoji/020.png","game/mishy-emoji/072.png","game/mishy-sticker/031.png","game/mishy-sticker/063.png","background/main/0.png","background/main/1.png","background/main/2.png","background/main/3.png","background/main/4.png","background/main/5.png","background/game/easy.png","background/game/normal.png","background/game/hard.png","background/game/nightmare.png","background/game/infinity.png","background/game/game-clear.png","background/game/game-over.png","game/mishy-emoji/078.png","game/mishy-sticker/093.png","background/extra/grass.png","game/mishy-sticker/103.png","game/mishy-sticker/011.png","game/mishy-sticker/239-clean.png","game/kiseki/tio-01.png","game/kiseki/tio-02.png","background/extra/confetti.png","game/mishy-sticker/126-clean.png","game/mishy-sticker/041-clean.png","game/mishy-emoji/039.png"];for(e in s.mode)for(t in s.mode[e])i="game/"+(s.mode[e][t].folder?s.mode[e][t].folder:"mishy-sticker")+"/"+s.mode[e][t].img+".png",-1==n.indexOf(i)&&n.push(i);for(e=0,a=n.length;e<a;e++)s.preload.image(n[e]);s.preload.list=n},image:function(e){(new Image).src=s.preload.imgPath+e}},init:function(){s.preload.assets();for(var e in s.toggle)"option"!=e&&s.toggle[e](!0);s.setClearFlags(),s.setMainBG(),a.body.className=a.body.className.replace(" loading","")}};e.Mishy=s}(window,document);